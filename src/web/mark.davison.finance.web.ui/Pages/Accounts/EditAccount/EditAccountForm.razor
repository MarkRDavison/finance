@using mark.davison.common.Converters
@inherits ComponentWithState

<div>
    <TextInput 
        Id="add-account-form-name"
        Label="Name" 
        IsLabelDisplay="true"
        Width="100%"
        @bind-Value="ViewModel.Name"/>
    <TextInput 
        Id="add-account-form-account-number"
        Label="Account Number" 
        IsLabelDisplay="true"
        Width="100%"
        @bind-Value="ViewModel.AccountNumber"/>
    <DropdownList
        TId="Guid"
        Id="add-account-form-account-type"
        Label="Account type" 
        IsLabelDisplay="true"
        Width="100%"
        Placeholder="Select account type"
        Items="@_accountTypeItems"
        @bind-Value="ViewModel.AccountTypeId"/>
    <DropdownList
        TId="Guid"
        Id="add-account-form-currency"
        Label="Currency" 
        IsLabelDisplay="true"
        Width="100%"
        Placeholder="Select currency"
        Items="@_currencyItems"
        @bind-Value="ViewModel.CurrencyId"/>
    <CurrencyInput
        Id="add-account-form-virtual-balance"
        Label="Virtual balance" 
        IsLabelDisplay="true"
        Width="100%"
        CurrencyInfo="@_selectedCurrency"
        @bind-Value="@ViewModel.VirtualBalance"/>
    <CurrencyInput
        @ref="_openingBalance"
        Id="add-account-form-opening-balance"
        Label="Opening balance" 
        IsLabelDisplay="true"
        Width="100%"
        CurrencyInfo="@_selectedCurrency"
        @bind-Value="@ViewModel.OpeningBalance"/>
    <DateInput
        Width="100%"
        Id="add-account-form-opening-balance-date"
        IsLabelDisplay="true"
        Label="Opening balance date"
        @bind-Value="ViewModel.OpeningBalanceDate" />
</div>

@code {
    private CurrencyInput? _openingBalance;

    private List<IDropdownItem<Guid>> _accountTypeItems => ViewModel.LookupState.Instance.AccountTypes.Select(_ => new DropdownItem<Guid>(_.Id, _.Type)).Cast<IDropdownItem<Guid>>().ToList();

    private List<IDropdownItem<Guid>> _currencyItems => ViewModel.LookupState.Instance.Currencies.Select(_ => new DropdownItem<Guid>(_.Id, _.Name)).Cast<IDropdownItem<Guid>>().ToList();

    private CurrencyInfo? _selectedCurrency => ViewModel.LookupState.Instance.Currencies.Where(_ => _.Id == ViewModel.CurrencyId).Select(_ => new CurrencyInfo(_.Symbol, _.DecimalPlaces)).FirstOrDefault();

    [Parameter, EditorRequired]
    public EditAccountFormViewModel ViewModel { get; set; } = default!;

    protected override void OnInitialized()
    {
        ViewModel.LookupState = GetState<LookupState>();
        base.OnInitialized();
    }

}